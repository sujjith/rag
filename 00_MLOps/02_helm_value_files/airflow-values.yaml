executor: KubernetesExecutor
webserverSecretKey: e386047607184aded9252df65f90caa2

# Use external PostgreSQL (in 'postgresql' namespace)
postgresql:
  enabled: false
data:
  metadataConnection:
    user: postgres
    pass: postgres123
    protocol: postgresql
    host: postgresql.postgresql.svc.cluster.local
    port: 5432
    db: airflow

images:
  airflow:
    repository: airflow-custom
    tag: "3.0.2"
    pullPolicy: Never  # Use local image

# Use MinIO for logs (in 'minio' namespace)
logs:
  persistence:
    enabled: false
config:
  logging:
    remote_logging: 'True'
    remote_base_log_folder: 's3://airflow-logs'
    remote_log_conn_id: 'minio_default'

# Enable OpenLineage (connects to Marquez in 'marquez' namespace)
# CHANGED: 'extraEnv' -> 'env'
env:
  - name: AIRFLOW__LINEAGE__BACKEND
    value: "openlineage.lineage_backend.OpenLineageBackend"
  - name: OPENLINEAGE_URL
    value: "http://marquez-api.marquez.svc.cluster.local:5000"
  - name: OPENLINEAGE_NAMESPACE
    value: "airflow"

# Resource limits
webserver:
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 500m
  service:
    type: NodePort
    ports:
      - name: airflow-ui
        port: 8080
        nodePort: 30800
scheduler:
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 500m

# Airflow 3.x uses apiServer instead of webserver for the UI
apiServer:
  service:
    type: NodePort
    ports:
      - name: api-server
        port: 8080
        nodePort: 30800

# Git-sync for DAGs
dags:
  gitSync:
    enabled: true
    repo: https://github.com/sujjith/rag.git
    branch: main
    ref: main
    depth: 1
    maxFailures: 3
    subPath: "00_MLOps/04_usecases/usecase1_churn_prediction/airflow/dags"
    period: 60s
    # Credentials secret (we'll create this)
    credentialsSecret: git-credentials

# Shared storage for KubernetesExecutor task pods
workers:
  extraVolumes:
    - name: shared-data
      persistentVolumeClaim:
        claimName: airflow-shared-data
  extraVolumeMounts:
    - name: shared-data
      mountPath: /shared

# Create PVC via Helm (no separate kubectl apply needed)
extraManifests:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: airflow-shared-data
    spec:
      accessModes:
        - ReadWriteMany
      resources:
        requests:
          storage: 5Gi
      storageClassName: local-path
